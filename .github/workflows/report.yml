name: Deploy Grocery App

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:

  # =========================
  # 1. ANALYSE DU PROJET
  # =========================
  analyse:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Analyse README
        run: |
          echo "Projet détecté : Grocery Delivery Application"
          echo "Frontend: React"
          echo "Backend: Node + Express"
          echo "Database: MongoDB"
          echo "Auth: JWT"
  
  # =========================
  # 2. FRONTEND BUILD
  # =========================
  frontend:
    runs-on: ubuntu-latest
    needs: analyse
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Installer frontend
        run: |
          cd frontend
          npm install
          
      - name: Build frontend
        run: |
          cd frontend
          npm run build
          
      - name: Vérifier dossier dist
        run: |
          cd frontend
          if [ -d "dist" ]; then
            echo "✅ dist exists"
            ls -la dist/
          else
            echo "❌ dist missing! Build failed?"
            exit 1
          fi
          
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist
          
  # =========================
  # 3. BACKEND CHECK
  # =========================
  backend:
    runs-on: ubuntu-latest
    needs: analyse
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Installer backend
        run: |
          cd Backend
          npm install
          
      - name: Vérifier serveur
        run: |
          cd Backend
          echo "Backend dependencies installed successfully"
          # npm run server || echo "Serveur non lancé (normal en CI)"
          
  # =========================
  # 4. DEPLOIEMENT FRONTEND SUR VERCEL
  # =========================
  deploy-frontend:
    runs-on: ubuntu-latest
    needs: [frontend, backend]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18

    - name: Installer Vercel CLI
      run: npm install -g vercel@latest

    - name: Pull Vercel Environment Information
      run: |
        cd frontend
        vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
        
    - name: Build Project Artifacts
      run: |
        cd frontend
        vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
        
    - name: Deploy Project Artifacts to Vercel
      run: |
        cd frontend
        vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}