name: Deploy Grocery App

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:

  # =========================
  # 1. ANALYSE DU PROJET
  # =========================
  analyse:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Analyse README
        run: |
          echo "Projet détecté : Grocery Delivery Application"
          echo "Frontend: React"
          echo "Backend: Node + Express"
          echo "Database: MongoDB"
          echo "Auth: JWT"

  # =========================
  # 2. FRONTEND BUILD
  # =========================
  frontend:
    runs-on: ubuntu-latest
    needs: analyse
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Installer frontend
        run: |
          cd frontend
          npm install

      - name: Build frontend
        run: |
          cd frontend
          npm run build

      - name: Vérifier dossier dist
        run: |
          cd frontend
          if [ -d "dist" ]; then
            echo "✅ dist exists"
          else
            echo "❌ dist missing! Build failed?"
            exit 1
          fi

  # =========================
  # 3. BACKEND CHECK
  # =========================
  backend:
    runs-on: ubuntu-latest
    needs: analyse
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Installer backend
        run: |
          cd Backend
          npm install

      - name: Vérifier serveur
        run: |
          cd Backend
          npm run server || echo "Serveur non lancé (normal en CI)"

  # =========================
  # 4. DEPLOIEMENT FRONTEND SUR VERCEL
  # =========================
  deploy-frontend:
    runs-on: ubuntu-latest
    needs: frontend
    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 18

    # L'installation du CLI est déjà faite, mais on peut la garder
    - name: Installer Vercel CLI
      run: npm install -g vercel

    - name: Deploy frontend sur Vercel
      run: |
        cd frontend
        # L'option --build-command est optionnelle si vercel.json contient déjà le build‑command
        vercel \
          --prod \
          --yes \
          --token ${{ secrets.VERCEL_TOKEN }} \
          --build-command "npm run build" \
          --output-directory "dist"
